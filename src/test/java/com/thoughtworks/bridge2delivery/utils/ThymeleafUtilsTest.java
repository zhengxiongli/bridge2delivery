package com.thoughtworks.bridge2delivery.utils;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.thoughtworks.bridge2delivery.swagger.SwaggerUtils;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.util.Assert;

import java.util.HashMap;
import java.util.Map;

@SpringBootTest
public class ThymeleafUtilsTest {
    private static final String SWAGGER_JSON = "{\"swagger\":\"2.0\",\"info\":{\"description\":\"API接口文档\",\"version\":\"1.1.0\",\"title\":\"嘀嗒交付小程序swagger测试程序\"},\"host\":\"localhost:8081\",\"basePath\":\"/\",\"tags\":[{\"name\":\"测试类标签\",\"description\":\"测试接口类\"},{\"name\":\"示列接口tag\",\"description\":\"示列接口\"}],\"paths\":{\"/demo/list\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"list\",\"description\":\"data类型为list\",\"operationId\":\"listUsingGET\",\"produces\":[\"*/*\"],\"parameters\":[{\"name\":\"pageIndex\",\"in\":\"query\",\"description\":\"页码\",\"required\":false,\"type\":\"integer\",\"default\":1,\"format\":\"int32\",\"allowEmptyValue\":false},{\"name\":\"pageSize\",\"in\":\"query\",\"description\":\"每页显示条数\",\"required\":false,\"type\":\"integer\",\"default\":15,\"format\":\"int32\",\"allowEmptyValue\":false},{\"name\":\"param\",\"in\":\"query\",\"description\":\"param\",\"required\":false,\"type\":\"integer\",\"format\":\"int32\"}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse«List«Result»»\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/list/list\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"list\",\"description\":\"两个list\",\"operationId\":\"listListUsingGET\",\"consumes\":[\"multipart/form-data\"],\"produces\":[\"*/*\"],\"parameters\":[{\"name\":\"file\",\"in\":\"formData\",\"description\":\"file\",\"required\":true,\"type\":\"file\"},{\"name\":\"param\",\"in\":\"query\",\"description\":\"param\",\"required\":true,\"type\":\"integer\",\"format\":\"int64\"}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse«List«List«Result»»»\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/list2\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"list2\",\"description\":\"直接返回list\",\"operationId\":\"list2UsingGET\",\"produces\":[\"*/*\"],\"parameters\":[{\"name\":\"pageIndex\",\"in\":\"query\",\"description\":\"页码\",\"required\":false,\"type\":\"integer\",\"default\":1,\"format\":\"int32\",\"allowEmptyValue\":false},{\"name\":\"pageSize\",\"in\":\"query\",\"description\":\"每页显示条数\",\"required\":false,\"type\":\"integer\",\"default\":15,\"format\":\"int32\",\"allowEmptyValue\":false},{\"name\":\"param\",\"in\":\"query\",\"description\":\"param\",\"required\":false,\"type\":\"string\"}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/definitions/Result\"}}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/pageresult\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"pageresult\",\"description\":\"data类型为PageResult\",\"operationId\":\"pageResultUsingGET\",\"produces\":[\"*/*\"],\"parameters\":[{\"name\":\"pageIndex\",\"in\":\"query\",\"required\":false,\"type\":\"integer\",\"format\":\"int32\"},{\"name\":\"pageSize\",\"in\":\"query\",\"required\":false,\"type\":\"integer\",\"format\":\"int32\"}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse«PageResult«Result»»\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false},\"post\":{\"tags\":[\"示列接口tag\"],\"summary\":\"pageresult post\",\"description\":\"post page result\",\"operationId\":\"postUsingPOST\",\"consumes\":[\"application/json\"],\"produces\":[\"*/*\"],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse«PageResult«Result»»\"}},\"201\":{\"description\":\"Created\"},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/path/{path}\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"path\",\"description\":\"带路径参数API\",\"operationId\":\"pathUsingGET\",\"produces\":[\"*/*\"],\"parameters\":[{\"name\":\"pageIndex\",\"in\":\"query\",\"description\":\"页码\",\"required\":false,\"type\":\"integer\",\"default\":1,\"format\":\"int32\",\"allowEmptyValue\":false},{\"name\":\"pageSize\",\"in\":\"query\",\"description\":\"每页显示条数\",\"required\":false,\"type\":\"integer\",\"default\":15,\"format\":\"int32\",\"allowEmptyValue\":false},{\"name\":\"param\",\"in\":\"query\",\"description\":\"param\",\"required\":false,\"type\":\"string\"},{\"name\":\"path\",\"in\":\"path\",\"description\":\"路径参数\",\"required\":false,\"type\":\"string\"}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse«List«Result»»\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/request\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"request\",\"description\":\"带参数\",\"operationId\":\"requestUsingGET\",\"produces\":[\"*/*\"],\"parameters\":[{\"in\":\"body\",\"name\":\"request\",\"description\":\"json请求\",\"required\":false,\"schema\":{\"$ref\":\"#/definitions/Request\"}}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/string\":{\"get\":{\"tags\":[\"示列接口tag\"],\"summary\":\"string\",\"description\":\"data类型为String\",\"operationId\":\"stringUsingGET\",\"produces\":[\"*/*\"],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse«int»\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/demo/upload\":{\"post\":{\"tags\":[\"示列接口tag\"],\"summary\":\"upload\",\"description\":\"上传文件\",\"operationId\":\"uploadUsingPOST\",\"consumes\":[\"application/json\"],\"produces\":[\"*/*\"],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"$ref\":\"#/definitions/ApiResponse\"}},\"201\":{\"description\":\"Created\"},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/test\":{\"get\":{\"tags\":[\"测试类标签\"],\"summary\":\"测试接口\",\"description\":\"测试接口notes\",\"operationId\":\"test1UsingGET\",\"produces\":[\"*/*\"],\"parameters\":[{\"name\":\"param1\",\"in\":\"query\",\"description\":\"参数1\",\"required\":false,\"type\":\"integer\",\"default\":0,\"format\":\"int32\",\"allowEmptyValue\":false}],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"type\":\"string\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}},\"/test/2\":{\"get\":{\"tags\":[\"测试类标签\"],\"summary\":\"测试接口2\",\"description\":\"测试接口2notes\",\"operationId\":\"test2UsingGET\",\"produces\":[\"*/*\"],\"responses\":{\"200\":{\"description\":\"OK\",\"schema\":{\"type\":\"string\"}},\"401\":{\"description\":\"Unauthorized\"},\"403\":{\"description\":\"Forbidden\"},\"404\":{\"description\":\"Not Found\"}},\"deprecated\":false}}},\"definitions\":{\"ApiResponse\":{\"type\":\"object\",\"properties\":{\"data\":{\"type\":\"object\",\"description\":\"返回数据结构\"},\"errCode\":{\"type\":\"integer\",\"format\":\"int32\",\"example\":404,\"description\":\"自定义错误code\"},\"message\":{\"type\":\"string\",\"example\":\"not found\",\"description\":\"错误消息\"}},\"title\":\"ApiResponse\",\"description\":\"统一返回数据结构\"},\"ApiResponse«List«List«Result»»»\":{\"type\":\"object\",\"properties\":{\"data\":{\"type\":\"array\",\"description\":\"返回数据结构\",\"items\":{\"type\":\"array\",\"items\":{\"$ref\":\"#/definitions/Result\"}}},\"errCode\":{\"type\":\"integer\",\"format\":\"int32\",\"example\":404,\"description\":\"自定义错误code\"},\"message\":{\"type\":\"string\",\"example\":\"not found\",\"description\":\"错误消息\"}},\"title\":\"ApiResponse«List«List«Result»»»\",\"description\":\"统一返回数据结构\"},\"ApiResponse«List«Result»»\":{\"type\":\"object\",\"properties\":{\"data\":{\"type\":\"array\",\"description\":\"返回数据结构\",\"items\":{\"$ref\":\"#/definitions/Result\"}},\"errCode\":{\"type\":\"integer\",\"format\":\"int32\",\"example\":404,\"description\":\"自定义错误code\"},\"message\":{\"type\":\"string\",\"example\":\"not found\",\"description\":\"错误消息\"}},\"title\":\"ApiResponse«List«Result»»\",\"description\":\"统一返回数据结构\"},\"ApiResponse«PageResult«Result»»\":{\"type\":\"object\",\"properties\":{\"data\":{\"description\":\"返回数据结构\",\"$ref\":\"#/definitions/PageResult«Result»\"},\"errCode\":{\"type\":\"integer\",\"format\":\"int32\",\"example\":404,\"description\":\"自定义错误code\"},\"message\":{\"type\":\"string\",\"example\":\"not found\",\"description\":\"错误消息\"}},\"title\":\"ApiResponse«PageResult«Result»»\",\"description\":\"统一返回数据结构\"},\"ApiResponse«int»\":{\"type\":\"object\",\"properties\":{\"data\":{\"type\":\"integer\",\"format\":\"int32\",\"description\":\"返回数据结构\"},\"errCode\":{\"type\":\"integer\",\"format\":\"int32\",\"example\":404,\"description\":\"自定义错误code\"},\"message\":{\"type\":\"string\",\"example\":\"not found\",\"description\":\"错误消息\"}},\"title\":\"ApiResponse«int»\",\"description\":\"统一返回数据结构\"},\"PageResult«Result»\":{\"type\":\"object\",\"properties\":{\"results\":{\"type\":\"array\",\"description\":\"结果集\",\"items\":{\"$ref\":\"#/definitions/Result\"}},\"total\":{\"type\":\"integer\",\"format\":\"int32\",\"description\":\"总条数\"}},\"title\":\"PageResult«Result»\",\"description\":\"分页结果返回值\"},\"Request\":{\"type\":\"object\",\"properties\":{\"param1\":{\"type\":\"integer\",\"format\":\"int32\",\"description\":\"请求参数1\"},\"param2\":{\"type\":\"string\",\"description\":\"请求参数2\"},\"subRequest\":{\"description\":\"子类\",\"$ref\":\"#/definitions/SubRequest\"}},\"title\":\"Request\",\"description\":\"请求类\"},\"Result\":{\"type\":\"object\",\"properties\":{\"field1\":{\"type\":\"string\",\"example\":\"string\",\"description\":\"返回字段1\"},\"field2\":{\"type\":\"integer\",\"format\":\"int32\",\"example\":\"string2\",\"description\":\"返回字段2\"},\"value\":{\"type\":\"string\",\"example\":\"enum\",\"description\":\"返回字段3\",\"enum\":[\"VALUE1\",\"VALUE2\"]}},\"title\":\"Result\",\"description\":\"返回结果数据结构\"},\"SubRequest\":{\"type\":\"object\",\"properties\":{\"param1\":{\"type\":\"integer\",\"format\":\"int32\",\"description\":\"参数1\"},\"param2\":{\"type\":\"string\",\"description\":\"参数2\"}},\"title\":\"SubRequest\",\"description\":\"请求子类\"}}}";
    private static final String TEMPLATE = "<!DOCTYPE html>\n" +
            "<html lang=\"en\" xmlns:th=\"http://www.thymeleaf.org\">\n" +
            "<head>\n" +
            "    <meta http-equiv=\"Content-Type\" content=\"application/msword\"/>\n" +
            "    <title th:text=\"${swaggerInfo.title}\"></title>\n" +
            "</head>\n" +
            "<body>\n" +
            "    <h1>\n" +
            "        <span th:text=\"${swaggerInfo.title}\" style=\"padding-right: 10px\"></span>\n" +
            "        <span>version:</span>\n" +
            "        <span th:text=\"${swaggerInfo.version}\"></span>\n" +
            "    </h1>\n" +
            "    <h3 th:text=\"${swaggerInfo.description}\"></h3>\n" +
            "</body>\n" +
            "</html>";
    @Autowired
    private ThymeleafUtils thymeleafUtils;

    @Test
    public void test() throws JsonProcessingException {
        Map<String, Object> map = new HashMap<>();
        map.put("swaggerInfo", SwaggerUtils.parseSwaggerJson(SWAGGER_JSON));
        String html = thymeleafUtils.renderTemplate(TEMPLATE, map);
        Assert.notNull(html, "can not be null");
        System.out.println(html);
    }
}